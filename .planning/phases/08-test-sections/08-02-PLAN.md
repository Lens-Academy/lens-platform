---
phase: 08-test-sections
plan: 02
type: tdd
wave: 2
depends_on: ["08-01"]
files_modified:
  - web_frontend/src/views/Module.tsx
  - web_frontend/src/components/module/StageProgressBar.tsx
  - web_frontend/src/components/module/ModuleDrawer.tsx
  - web_frontend/src/components/course/ModuleOverview.tsx
  - web_frontend/src/components/module/__tests__/ContentHiding.test.tsx
autonomous: false

must_haves:
  truths:
    - "During test mode, lesson section progress dots are dimmed and not clickable"
    - "During test mode, prev/next navigation does not leave the test section"
    - "During test mode, the drawer sidebar greys out lesson sections"
    - "After all test questions are answered, all navigation is restored (dots clickable, prev/next work, drawer normal)"
    - "Test mode activates when Begin is clicked and deactivates when all questions are completed"
  artifacts:
    - path: "web_frontend/src/views/Module.tsx"
      provides: "testModeActive state, modified handleStageClick/handlePrevious/handleNext"
      contains: "testModeActive"
    - path: "web_frontend/src/components/module/StageProgressBar.tsx"
      provides: "Dimmed dots during test mode"
      contains: "testModeActive"
    - path: "web_frontend/src/components/module/ModuleDrawer.tsx"
      provides: "Pass-through of testModeActive to ModuleOverview"
      contains: "testModeActive"
    - path: "web_frontend/src/components/course/ModuleOverview.tsx"
      provides: "Dimmed/disabled lesson items during test mode"
      contains: "testModeActive"
    - path: "web_frontend/src/components/module/__tests__/ContentHiding.test.tsx"
      provides: "TDD tests for content hiding DOM behavior"
      min_lines: 60
  key_links:
    - from: "web_frontend/src/views/Module.tsx"
      to: "web_frontend/src/components/module/TestSection.tsx"
      via: "onTestStart/onTestComplete callbacks set testModeActive"
      pattern: "setTestModeActive"
    - from: "web_frontend/src/views/Module.tsx"
      to: "web_frontend/src/components/module/StageProgressBar.tsx"
      via: "testModeActive prop controls dot dimming"
    - from: "web_frontend/src/views/Module.tsx"
      to: "web_frontend/src/components/module/ModuleDrawer.tsx"
      via: "testModeActive prop passed through to drawer"
---

<objective>
Add content hiding behavior during test mode: when a student is taking a test, lesson section navigation is dimmed and restricted. Progress dots become non-clickable and visually dimmed, the drawer sidebar greys out lesson sections, and prev/next navigation is bounded to the test section. Navigation fully restores when the test is complete. Use TDD with React Testing Library to drive the dimming and click-blocking behavior.

Purpose: This implements the "disincentivize but don't prevent" content review policy -- a UX speed bump that keeps students focused on the test without hard-blocking access. TDD ensures the conditional DOM output (dimmed/disabled states) is correct as a function of testModeActive input.
Output: Test file, modified navigation components that respond to testModeActive state.
</objective>

<execution_context>
@/home/penguin/.claude/get-shit-done/workflows/execute-plan.md
@/home/penguin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-test-sections/08-CONTEXT.md
@.planning/phases/08-test-sections/08-RESEARCH.md
@.planning/phases/08-test-sections/08-01-SUMMARY.md

Key files to read before implementing:
@web_frontend/src/views/Module.tsx (current state after Plan 01 -- handleStageClick, handlePrevious, handleNext, onTestStart/onTestComplete callbacks)
@web_frontend/src/components/module/StageProgressBar.tsx (renderDot, button onClick, prev/next buttons)
@web_frontend/src/components/module/ModuleDrawer.tsx (passes stages + onStageClick to ModuleOverview)
@web_frontend/src/components/course/ModuleOverview.tsx (renders vertical stage list with click handlers)

Existing test patterns to follow:
@web_frontend/src/views/__tests__/Module.progress.test.tsx (mock patterns for useAuth, API modules, render + waitFor)
@web_frontend/src/components/module/__tests__/TestSection.test.tsx (TDD patterns from Plan 01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: RED -- Write failing tests for content hiding behavior</name>
  <files>
    web_frontend/src/components/module/__tests__/ContentHiding.test.tsx
  </files>
  <action>
    Create a test file for content hiding DOM behavior. The key insight: StageProgressBar and ModuleOverview accept a `testModeActive` prop, and their DOM output changes as a function of that prop. We can test these components in isolation.

    Create `web_frontend/src/components/module/__tests__/ContentHiding.test.tsx`:

    ```tsx
    import { describe, it, expect, vi, beforeEach } from "vitest";
    import { render, screen } from "@testing-library/react";
    import userEvent from "@testing-library/user-event";
    ```

    **Testing StageProgressBar dimming:**

    Import StageProgressBar directly. It needs props: `stages`, `currentStageIndex`, `completedStages`, `onDotClick`, and the new `testModeActive`. Build mock stages array with 3 stages (2 article + 1 test).

    ```tsx
    const mockStages = [
      { type: "article", source: "", from: null, to: null, title: "Lesson 1" },
      { type: "article", source: "", from: null, to: null, title: "Lesson 2" },
      { type: "test", source: "", from: null, to: null, title: "Test" },
    ];
    ```

    **describe("StageProgressBar content hiding")**
    - `it("dims non-test dots when testModeActive is true")` - Render StageProgressBar with testModeActive=true. Find all dot buttons. Assert lesson dot buttons have `opacity-30` class (or are disabled). Assert test dot does NOT have `opacity-30`.
    - `it("does not dim dots when testModeActive is false")` - Render with testModeActive=false. Assert no dot buttons have `opacity-30`.
    - `it("blocks click on non-test dots during test mode")` - Render with testModeActive=true and an onDotClick mock. Click a lesson dot. Assert onDotClick was NOT called. Click the test dot. Assert onDotClick WAS called (or at least was not blocked at this level -- the blocking may happen in Module.tsx).

    **Testing ModuleOverview dimming:**

    Import ModuleOverview. It needs props: `stages` (StageInfo[]), `currentStageIndex`, `completedStages`, `onStageClick`, and the new `testModeActive`. Build mock StageInfo data.

    ```tsx
    const mockStageInfos = [
      { title: "Lesson 1", type: "article", completed: false },
      { title: "Lesson 2", type: "article", completed: false },
      { title: "Test", type: "test", completed: false },
    ];
    ```

    **describe("ModuleOverview content hiding")**
    - `it("dims lesson items when testModeActive is true")` - Render with testModeActive=true. Assert lesson items have `opacity-30` or `pointer-events-none` class. Assert test item does NOT have these classes.
    - `it("does not dim items when testModeActive is false")` - Render with testModeActive=false. Assert no items have `opacity-30`.

    All tests should FAIL since testModeActive prop doesn't exist yet on these components.

    Run: `cd /home/penguin/code/lens-platform/ws3/web_frontend && npx vitest run src/components/module/__tests__/ContentHiding.test.tsx 2>&1 | tail -40` -- all tests should fail.

    Commit: `test(08-02): add failing tests for content hiding during test mode`
  </action>
  <verify>
    Run `cd /home/penguin/code/lens-platform/ws3/web_frontend && npx vitest run src/components/module/__tests__/ContentHiding.test.tsx 2>&1 | tail -40`. All tests should FAIL (RED state). Failures should be because testModeActive prop is not recognized or dimming classes are not applied.
  </verify>
  <done>
    Test file exists with 5+ failing test cases covering: dot dimming, dot click blocking, and drawer item dimming as a function of testModeActive. All tests fail because the prop and behavior don't exist yet (RED state).
  </done>
</task>

<task type="auto">
  <name>Task 2: GREEN -- Implement content hiding in StageProgressBar, ModuleDrawer, ModuleOverview, and Module.tsx</name>
  <files>
    web_frontend/src/views/Module.tsx
    web_frontend/src/components/module/StageProgressBar.tsx
    web_frontend/src/components/module/ModuleDrawer.tsx
    web_frontend/src/components/course/ModuleOverview.tsx
  </files>
  <action>
    Implement content hiding to make all failing tests pass:

    **Module.tsx:**

    1. Add state: `const [testModeActive, setTestModeActive] = useState(false);`

    2. Wire TestSection callbacks:
       ```tsx
       onTestStart={() => setTestModeActive(true)}
       onTestComplete={() => setTestModeActive(false)}
       ```

    3. Modify handleStageClick to block non-test navigation during test:
       ```ts
       if (testModeActive && module) {
         const targetSection = module.sections[index];
         if (targetSection?.type !== "test") return;
       }
       ```

    4. Modify handlePrevious/handleNext: return early during test mode.

    5. Adjust canGoPrevious/canGoNext during test mode:
       ```ts
       canGoPrevious={!testModeActive && currentSectionIndex > 0}
       canGoNext={!testModeActive && currentSectionIndex < module.sections.length - 1}
       ```

    6. Pass `testModeActive` to StageProgressBar and ModuleDrawer.

    **StageProgressBar.tsx:**

    1. Add `testModeActive?: boolean` prop.
    2. In `renderDot`, compute dimming:
       ```tsx
       const isTestDot = stage.type === "test" || stage.title?.toLowerCase() === "test";
       const isDimmed = testModeActive && !isTestDot;
       ```
    3. Apply `opacity-30 cursor-default` and `disabled` to dimmed dots. Use `cursor-default` not `cursor-not-allowed` per project guidelines.
    4. Dim connector lines during test mode.

    **ModuleDrawer.tsx:**

    1. Add `testModeActive?: boolean` prop.
    2. Pass through to ModuleOverview.

    **ModuleOverview.tsx:**

    1. Add `testModeActive?: boolean` prop.
    2. For each stage item, compute:
       ```tsx
       const isTestStage = stages[index].type === "test";
       const isDimmed = testModeActive && !isTestStage;
       ```
    3. Apply `opacity-30 pointer-events-none` to dimmed items. Use `cursor-default`.

    Run tests after implementing. Iterate until all pass.
  </action>
  <verify>
    Run `cd /home/penguin/code/lens-platform/ws3/web_frontend && npx vitest run src/components/module/__tests__/ContentHiding.test.tsx 2>&1 | tail -40`. All tests should PASS (GREEN state).

    Also run Plan 01 tests to ensure no regressions: `npx vitest run src/components/module/__tests__/TestSection.test.tsx 2>&1 | tail -20`.

    Run full build: `npm run build 2>&1 | tail -20` and `npm run lint 2>&1 | tail -20`.

    Commit: `feat(08-02): implement content hiding during test mode`
  </verify>
  <done>
    testModeActive state exists in Module.tsx wired to TestSection callbacks. StageProgressBar dims non-test dots. ModuleOverview dims non-test items. handleStageClick/handlePrevious/handleNext are restricted during test mode. All TDD tests pass. Build passes.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Visual verification of test section flow</name>
  <files>
    web_frontend/src/views/Module.tsx
    web_frontend/src/components/module/StageProgressBar.tsx
    web_frontend/src/components/module/ModuleDrawer.tsx
    web_frontend/src/components/course/ModuleOverview.tsx
    web_frontend/src/components/module/TestSection.tsx
    web_frontend/src/components/module/TestQuestionCard.tsx
  </files>
  <action>
    Human verifies the complete test section implementation:

    What was built: Test sections render in the module viewer with Begin screen, sequential question reveal with collapse, timer tracking, resume support, auto-completion, content hiding (dimmed/disabled navigation during test), and full navigation restoration after test completion.

    How to verify:
    1. Start the dev server: `cd /home/penguin/code/lens-platform/ws3 && .venv/bin/python main.py --dev --port 8300` and `cd web_frontend && npm run dev -- --host --port 3300`
    2. Navigate to a module that has a test section (e.g., `http://dev.vps:3300/module/demo` or whichever module has `## Test:` content)
    3. Verify:
       a. Test section appears with its own progress dot (checkmark icon, distinct from article/video/chat)
       b. Clicking the test section shows a Begin screen with question count
       c. Clicking "Begin" enters test mode: lesson dots become dimmed and unclickable, prev/next arrows are disabled
       d. First question appears with its prompt and AnswerBox
       e. After answering and clicking "Finish", the question collapses and a "Next question" button appears
       f. After answering all questions, navigation unlocks (dots bright, arrows work)
       g. The test section progress dot fills in (marked complete)
    4. Resume test: reload the page mid-test -- verify answered questions appear collapsed and next unanswered question shows the reveal button
    5. Verify the drawer sidebar: lesson sections should appear greyed out during test, normal after completion

    Resume signal: Type "approved" or describe any issues to fix
  </action>
  <verify>User confirms all verification steps pass.</verify>
  <done>Complete test section flow verified by human: Begin screen, sequential questions, content hiding, resume, and completion all work correctly.</done>
</task>

</tasks>

<verification>
1. `cd /home/penguin/code/lens-platform/ws3/web_frontend && npx vitest run src/components/module/__tests__/ContentHiding.test.tsx` -- all tests pass
2. `cd /home/penguin/code/lens-platform/ws3/web_frontend && npx vitest run src/components/module/__tests__/TestSection.test.tsx` -- Plan 01 tests still pass
3. `cd /home/penguin/code/lens-platform/ws3/web_frontend && npm run build` passes without errors
4. `cd /home/penguin/code/lens-platform/ws3/web_frontend && npm run lint` passes
5. During test mode, lesson progress dots are visually dimmed (opacity-30) and non-clickable
6. During test mode, prev/next arrows are disabled
7. During test mode, drawer sidebar lesson items are greyed out
8. After test completion, all navigation is fully restored
9. testModeActive state toggles correctly via TestSection callbacks
</verification>

<success_criteria>
- All TDD tests pass (dot dimming, click blocking, drawer dimming)
- Content hiding activates when Begin is clicked (dots dim, clicks blocked, arrows disabled)
- Content hiding deactivates when all questions are answered (dots bright, clicks work, arrows enabled)
- Visual dimming is consistent across progress bar and drawer
- No cursor-not-allowed used anywhere (cursor-default for disabled states per project guidelines)
- Navigation restriction is a speed bump, not a wall (URL hash manipulation still works, per user decision)
- Human verification confirms the full flow works end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/08-test-sections/08-02-SUMMARY.md`
</output>
